name: MinTic Delete AWS CloudFormation Stacks (Multi-Stage)

on:
  workflow_dispatch:

jobs:
  delete:
    runs-on: ubuntu-latest

    steps:
    - name: MinTic Checkout and download repository
      uses: actions/checkout@v3

    - name: MinTic Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-east-1

    - name: Stage 1 - Delete ASG Stack
      run: |
        echo "  Stage 1: Eliminando Auto Scaling Group..."
        aws cloudformation delete-stack --stack-name MinticASGStack || echo "âš ï¸  Stack MinticASGStack no encontrado"
        echo " Esperando eliminaciÃ³n completa..."
        aws cloudformation wait stack-delete-complete --stack-name MinticASGStack || echo "âœ… Stack ya eliminado"
        echo " ASG eliminado"
        echo ""

    - name: Stage 2 - Delete ALB Stack
      run: |
        echo "  Stage 2: Eliminando Application Load Balancer..."
        aws cloudformation delete-stack --stack-name MinticALBStack || echo "âš ï¸  Stack MinticALBStack no encontrado"
        echo " Esperando eliminaciÃ³n completa..."
        aws cloudformation wait stack-delete-complete --stack-name MinticALBStack || echo "âœ… Stack ya eliminado"
        echo " ALB eliminado"
        echo ""

    - name: Stage 3 - Delete EC2 Stack
      run: |
        echo "  Stage 3: Eliminando instancias EC2 estÃ¡ticas..."
        aws cloudformation delete-stack --stack-name MinticEC2Stack || echo "âš ï¸  Stack MinticEC2Stack no encontrado"
        echo " Esperando eliminaciÃ³n completa..."
        aws cloudformation wait stack-delete-complete --stack-name MinticEC2Stack || echo "âœ… Stack ya eliminado"
        echo " EC2 instances eliminadas"
        echo ""

    - name: Stage 4 - Delete Security Stack
      run: |
        echo "  Stage 4: Eliminando Security Group..."
        aws cloudformation delete-stack --stack-name MinticSecurityStack || echo "âš ï¸  Stack MinticSecurityStack no encontrado"
        echo " Esperando eliminaciÃ³n completa..."
        aws cloudformation wait stack-delete-complete --stack-name MinticSecurityStack || echo "âœ… Stack ya eliminado"
        echo " Security Group eliminado"
        echo ""

    - name: Stage 5 - Delete VPC Stack
      run: |
        echo "  Stage 5: Eliminando VPC, Subnets e Internet Gateway..."
        aws cloudformation delete-stack --stack-name MinticVPCStack || echo "âš ï¸  Stack MinticVPCStack no encontrado"
        echo " Esperando eliminaciÃ³n completa..."
        aws cloudformation wait stack-delete-complete --stack-name MinticVPCStack || echo "âœ… Stack ya eliminado"
        echo " VPC eliminada"
        echo ""

    - name: Summary
      run: |
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo " ELIMINACIÃ“N COMPLETADA EXITOSAMENTE"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        echo "ğŸ“¦ Recursos eliminados en orden:"
        echo "  1. Auto Scaling Group (4 EC2)"
        echo "  2. Application Load Balancer"
        echo "  3. EC2 Instances estÃ¡ticas (2)"
        echo "  4. Security Group"
        echo "  5. VPC, Subnets, Internet Gateway"
        echo ""
        echo "  Recursos preservados:"
        echo "  - S3 Bucket: mintic-bucket-680578888516-us-east-1"
        echo "  - IAM Role: Despliegue_EC2"
        echo ""